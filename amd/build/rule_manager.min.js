define(["require","exports","./rules","./actor_modal","./core_helper","./sensor_viewport","./sensor_tab","./sensor_idle"],(function(e,t,o,n,r,i,s,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RuleManager=void 0;class a{constructor(e){this.rules=[],this.lm=e,this.actionQueue=[],this.moodleContext=this._determineMoodleContext(),this.moodleInstanceID=this._determineURLParameters("id"),this.browserTabID=s.getTabID(),console.log("current context:",this.moodleContext,this.moodleInstanceID,this.browserTabID),this.rules=(new o.Rules).getAll(),this._checkRules()}_determineMoodleContext(){let e=window.location.pathname;switch(e=e.replace("/moodle",""),e){case"/login/index.php":return o.EMoodleContext.LOGIN_PAGE;case"/":return o.EMoodleContext.HOME_PAGE;case"/user/profile.php":return o.EMoodleContext.PROFILE_PAGE;case"/user/index.php":return o.EMoodleContext.COURSE_PARTICIPANTS;case"/course/view.php":return o.EMoodleContext.COURSE_OVERVIEW_PAGE;case"/mod/page/view.php":return o.EMoodleContext.MOD_PAGE;case"/mod/assign/view.php":return o.EMoodleContext.MOD_ASSIGNMENT;case"/mod/newsmod/view.php":return o.EMoodleContext.MOD_NEWSMOD;case"/mod/quiz/view.php":return o.EMoodleContext.MOD_QUIZ;case"/mod/quiz/attempt.php":return o.EMoodleContext.MOD_QUIZ_ATTEMPT;case"/mod/quiz/summary.php":return o.EMoodleContext.MOD_QUIZ_SUMMARY;case"/mod/quiz/review.php":return o.EMoodleContext.MOD_QUIZ_REVIEW}return o.EMoodleContext.UNKNOWN}_determineURLParameters(e){let t=document.createElement("a");t.href=window.location.href;for(var o=t.search.substring(1).split("&"),n=0;n<o.length;n++){var r=o[n].split("=");if(r[0]===e)return decodeURIComponent(r[1])}return-1}_checkRules(){for(var e=0;e<this.rules.length;e++)this.evaluateConditions(this.rules[e].Condition)&&this._addToActionQueue(this.rules[e].Action)}getLearnerModelKey(e,t){return void 0!==t&&this.lm[e][t]}evaluateConditions(e){let t=!0;for(var n=0;n<e.length;n++){let r=e[n];switch(r.operator){case o.EOperators.Equal:t=!(!t||this.getLearnerModelKey(r.context,r.key)!==r.value);break;default:t=!1}}return t}_addToActionQueue(e){this.actionQueue.push(e),this._processActionQueue()}_processActionQueue(){let e=this,t=this.actionQueue.filter((function(t){return t.moodle_context===e.moodleContext}));for(var n=0;n<t.length;n++)t[n].timing===o.ETiming.WHEN_VISIBLE&&void 0!==t[n].viewport_selector?new i.DOMVPTracker(t[n].viewport_selector,0).get().then(e=>{console.log("z217 ",e)}):t[n].timing===o.ETiming.WHEN_IDLE&&void 0!==t[n].delay?l.sensor_idle(a._executeAction,t[n],t[n].delay):a._executeAction(t[n])}static _executeAction(e){switch(console.log("drinn"),e.method){case o.ERuleActor.Alert:console.log("Execute ALERT",e.text);break;case o.ERuleActor.Modal:console.log("Execute MODAL",e.text),a.initiateModal("Hinweis",e.text);break;default:new Error("Undefined rule action executed.")}}static initiateModal(e,t){let o={id:"modal-"+r.uniqid(),content:{header:'<h5 class="modal-title" id="exampleModalLabel">'+e+"</h5>",body:"<p>"+t+"</p>",footer:'<button type="button" class="btn btn-secondary" data-dismiss="modal">Jetzt nicht</button>             <button type="button" class="btn btn-primary">OK, habe verstanden</button>'},options:{centerVertically:!0,show:!0,focus:!0,keyboard:!0,backdrop:!0,animate:!0,size:n.EModalSize.small,showCloseButton:!0}};new n.Modal(o)}}t.RuleManager=a}));